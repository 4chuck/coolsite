<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multiplayer Quiz Game</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #game-container {
      padding: 20px;
    }
    select, input {
      padding: 10px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>Multiplayer Quiz Game</h1>
    <select id="category-dropdown">
      <option value="">Select a Category</option>
    </select>
    <div id="player-info">
      <button id="join-btn">Join Game</button>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBJs9fp6w30ZpxycPLGy2TFxk",
    authDomain: "login-b6382.firebaseapp.com",
    databaseURL: "https://login-b6382-default-rtdb.firebaseio.com",
    projectId: "login-b6382",
    storageBucket: "login-b6382.appspot.com",
    messagingSenderId: "482805184778",
    appId: "1:482805184778:web:5dfba2587a438a5ed7a2f3",
    measurementId: "G-S55NBV7G1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const categoryDropdown = document.getElementById("category-dropdown");
  const joinBtn = document.getElementById("join-btn");
  const logoutBtn = document.getElementById("logout-btn");

  let playerId;
  let playerName;

  // Check Authentication State
  onAuthStateChanged(auth, (user) => {
    if (user) {
      alert("User is authenticated: " + user.uid); // Debugging alert
      playerId = user.uid;
      playerName = user.displayName || "Player";
      fetchCategories();
    } else {
      alert("User is not authenticated. Redirecting to login."); // Debugging alert
      window.location.href = "UIname.html"; // Redirect to login
    }
  });

  // Fetch Categories from Open Trivia API
  async function fetchCategories() {
    alert("Fetching categories..."); // Debugging alert
    try {
      const res = await fetch("https://opentdb.com/api_category.php");
      if (!res.ok) {
        throw new Error(`Failed to fetch categories: ${res.statusText}`);
      }
      const data = await res.json();
      data.trivia_categories.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.id;
        option.textContent = category.name;
        categoryDropdown.appendChild(option);
      });
      alert("Categories fetched successfully."); // Debugging alert
    } catch (error) {
      console.error("Error fetching categories:", error);
      alert(`Error fetching categories: ${error.message}`); // Debugging alert
    }
  }

  // Player Joins the Game
  joinBtn.addEventListener("click", async () => {
    const selectedCategory = categoryDropdown.value;

    if (!selectedCategory) {
      alert("Please select a category."); // Debugging alert
      return;
    }

    alert(`Joining game in category: ${selectedCategory}`); // Debugging alert

    try {
      const playerRef = ref(db, `games/category_${selectedCategory}/players/${playerId}`);
      await set(playerRef, {
        name: playerName,
        score: 0,
        online: true,
      });

      // Handle disconnection
      onDisconnect(playerRef).update({ online: false });
      alert(`Joined game successfully as ${playerName}.`); // Debugging alert
    } catch (error) {
      console.error("Error joining game:", error);
      alert(`Error joining game: ${error.message}`); // Debugging alert
    }
  });

  // Logout Functionality
  logoutBtn.addEventListener("click", () => {
    alert("Logging out..."); // Debugging alert
    signOut(auth)
      .then(() => {
        alert("Logged out successfully."); // Debugging alert
        window.location.href = "UIname.html"; // Redirect to login
      })
      .catch((error) => {
        console.error("Logout Error:", error);
        alert(`Error logging out: ${error.message}`); // Debugging alert
      });
  });
</script>
</body>
</html>
