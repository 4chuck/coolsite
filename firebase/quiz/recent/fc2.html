<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Game</title>
  <!-- Firebase App (Base SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js"></script>
  <!-- Firebase Realtime Database SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="game-container">
    <h1>Online Quiz Game</h1>
    <div id="question-container">
      <p id="question"></p>
      <div id="answers"></div>
    </div>
    <div id="timer">Time Left: <span id="time">10</span>s</div>
    <div id="score">Score: <span id="current-score">0</span></div>
    <button id="start-btn">Start Game</button>
  </div>
  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <ul id="leaderboard-list"></ul>
  </div>
 <!-- <script type="module" src="fc.js"></script> -->
 <script type="module">
 
console.log("Script is running...");

// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBJs9fp6w30ZpxycPLGy2TFxk",
  authDomain: "login-b6382.firebaseapp.com",
  databaseURL: "https://login-b6382-default-rtdb.firebaseio.com",
  projectId: "login-b6382",
  storageBucket: "login-b6382.appspot.com",
  messagingSenderId: "482805184778",
  appId: "1:482805184778:web:5dfba2587a438a5ed7a2f3",
  measurementId: "G-S55NBV7G1T"
};

// Initialize Firebase
let db;
try {
  console.log("Initializing Firebase...");
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  console.log("Firebase initialized successfully.");
} catch (error) {
  console.error("Error initializing Firebase:", error.message);
}

// DOM Elements
const questionEl = document.getElementById("question");
const answersEl = document.getElementById("answers");
const timerEl = document.getElementById("time");
const scoreEl = document.getElementById("current-score");
const leaderboardEl = document.getElementById("leaderboard-list");
const startBtn = document.getElementById("start-btn");

// Create Restart Button
const restartBtn = document.createElement("button");
restartBtn.textContent = "Restart Quiz";
restartBtn.id = "restart-btn";
restartBtn.style.display = "none"; // Hide initially
restartBtn.style.margin = "20px auto"; // Center the button
startBtn.parentNode.appendChild(restartBtn);

const categoryDropdown = document.createElement("select");
document.body.insertBefore(
  categoryDropdown,
  document.getElementById("game-container")
);

let currentScore = 0;
let timer;
let questionIndex = 0;
let questions = [];

// Fetch Categories
async function fetchCategories() {
  console.log("Fetching categories...");
  try {
    const res = await fetch("https://opentdb.com/api_category.php");
    const data = await res.json();
    console.log("Categories fetched successfully:", data);

    data.trivia_categories.forEach((category) => {
      const option = document.createElement("option");
      option.value = category.id;
      option.textContent = category.name;
      categoryDropdown.appendChild(option);
    });
  } catch (error) {
    console.error("Error fetching categories:", error.message);
  }
}

// Fetch Questions
async function fetchQuestions(categoryId) {
  console.log(`Fetching questions for category ${categoryId}...`);
  try {
    const url = `https://opentdb.com/api.php?amount=10&category=${categoryId}&type=multiple`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.results.length === 0) {
      console.warn("No questions found for this category.");
      return;
    }

    console.log("Questions fetched successfully:", data);
    questions = data.results.map((q) => ({
      question: q.question,
      answers: shuffle([q.correct_answer, ...q.incorrect_answers]),
      correct: q.correct_answer,
    }));
  } catch (error) {
    console.error("Error fetching questions:", error.message);
  }
}

// Shuffle Answers
function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

// Display Question
function displayQuestion() {
  if (questionIndex >= questions.length) {
    endGame();
    return;
  }

  const { question, answers } = questions[questionIndex];
  questionEl.innerHTML = question;
  answersEl.innerHTML = "";
  answers.forEach((answer) => {
    const btn = document.createElement("button");
    btn.textContent = answer;
    btn.onclick = () => checkAnswer(answer);
    answersEl.appendChild(btn);
  });

  console.log(`Displaying question ${questionIndex + 1}`);
  startTimer();
}

// Check Answer
function checkAnswer(selected) {
  stopTimer();
  const correct = questions[questionIndex].correct;

  if (selected === correct) {
    currentScore += 10;
    scoreEl.textContent = currentScore;
    console.log("Correct answer! Current score:", currentScore);
  } else {
    console.log("Wrong answer! Correct was:", correct);
  }

  questionIndex++;
  displayQuestion();
}

// Timer
function startTimer() {
  let time = 10;
  timerEl.textContent = time;
  timer = setInterval(() => {
    time--;
    timerEl.textContent = time;

    if (time <= 0) {
      clearInterval(timer);
      console.log("Time's up!");
      questionIndex++;
      displayQuestion();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timer);
}

// End Game
function endGame() {
    const tim = document.getElementById("timer");
    
  console.log(`Game Over! Final score: ${currentScore}`);
  saveScore(currentScore);

  // Hide timer
  timerEl.style.display = "none";
  tim.style.display = "none";

  // Replace start button with restart button
  startBtn.style.display = "none";
  restartBtn.style.display = "block";

  questionEl.innerHTML = "Quiz Ended!";
  answersEl.innerHTML = "";
  displayLeaderboard();
}

// Save Score to Firebase
function saveScore(score) {
  const playerName = prompt("Enter your name:");
  if (!playerName) {
    console.warn("Name is required to save the score.");
    return;
  }

  const scoresRef = ref(db, `leaderboard/${playerName}`);
  set(scoresRef, { name: playerName, score })
    .then(() => {
      console.log(`Score saved successfully under leaderboard/${playerName}`);
    })
    .catch((error) => {
      console.error("Error saving score:", error.message);
    });
}

// Display Leaderboard
function displayLeaderboard() {
  console.log("Fetching leaderboard...");
  const leaderboardRef = ref(db, "leaderboard");
  onValue(leaderboardRef, (snapshot) => {
    const data = snapshot.val();
    console.log("Leaderboard data fetched:", data);

    if (data) {
      const sorted = Object.values(data).sort((a, b) => b.score - a.score);
      leaderboardEl.innerHTML = sorted
        .map((entry) => `<li>${entry.name}: ${entry.score}</li>`)
        .join("");
    } else {
      leaderboardEl.innerHTML = "<li>No scores yet</li>";
    }
  });
}

// Start Game
startBtn.addEventListener("click", async () => {
  const selectedCategory = categoryDropdown.value;
  currentScore = 0;
  questionIndex = 0;
  scoreEl.textContent = currentScore;

  console.log("Starting game...");
  startBtn.style.display = "none"; // Hide start button

  await fetchQuestions(selectedCategory);
  displayQuestion();
});

// Restart Game
restartBtn.addEventListener("click", () => {
  console.log("Restarting game...");
  questionIndex = 0;
  currentScore = 0;
  scoreEl.textContent = currentScore;
  questionEl.innerHTML = "";
  answersEl.innerHTML = "";
  leaderboardEl.innerHTML = "";
  restartBtn.style.display = "none"; // Hide restart button
  startBtn.style.display = "block"; // Show start button again
});

// Load Categories
fetchCategories();
</script>

</body>
</html>
